<!-- Copyright (C) 2025 Fotios Tsiadimos
     SPDX-License-Identifier: GPL-3.0-only -->
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Templates</h1>
            <p class="text-gray-500 mt-1">Manage your script templates (Bash & Python)</p>
        </div>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
            <div class="relative w-full sm:w-64">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" v-model="templateSearchQuery" placeholder="Search templates..." 
                    class="pl-9 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none transition">
            </div>
            <button @click="openGitSyncModal" class="px-4 py-2.5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 transition font-medium flex items-center justify-center gap-2 shadow-md">
                <i class="fab fa-git-alt"></i> <span>Git Sync</span>
            </button>
            <button @click="startNewTemplate" class="px-4 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition font-medium flex items-center justify-center gap-2 shadow-md">
                <i class="fas fa-plus"></i> <span>Create Template</span>
            </button>
        </div>
    </div>

    <!-- Git Sync Modal -->
    <div v-if="gitSyncModalOpen" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeGitSyncModal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="p-5 flex justify-between items-center bg-gradient-to-r from-orange-500 to-red-500">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                        <i class="fab fa-git-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg">Git Repository Sync</h3>
                        <p class="text-white/70 text-sm">Sync templates with a Git repository</p>
                    </div>
                </div>
                <button @click="closeGitSyncModal" class="w-10 h-10 rounded-lg bg-white/10 hover:bg-white/20 transition flex items-center justify-center text-white">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-5 space-y-5">
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-200">
                    <button @click="gitSyncTab = 'config'" 
                        :class="gitSyncTab === 'config' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-4 py-2.5 font-medium text-sm border-b-2 transition">
                        <i class="fas fa-cog mr-2"></i>Configuration
                    </button>
                    <button @click="gitSyncTab = 'sync'" 
                        :class="gitSyncTab === 'sync' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-4 py-2.5 font-medium text-sm border-b-2 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Sync
                    </button>
                    <button @click="gitSyncTab = 'backup'" 
                        :class="gitSyncTab === 'backup' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-4 py-2.5 font-medium text-sm border-b-2 transition">
                        <i class="fas fa-database mr-2"></i>Full Backup
                    </button>
                </div>

                <!-- Configuration Tab -->
                <div v-if="gitSyncTab === 'config'" class="space-y-4">
                    <!-- Repository URL -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-link mr-1 text-gray-400"></i> Repository URL
                        </label>
                        <input v-model="gitConfig.repo_url" 
                            placeholder="https://github.com/username/repo.git"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition font-mono text-sm">
                        <p class="text-xs text-gray-500 mt-1">HTTPS URL of your Git repository</p>
                    </div>

                    <!-- Branch -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-code-branch mr-1 text-gray-400"></i> Branch
                        </label>
                        <input v-model="gitConfig.branch" 
                            placeholder="main"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition text-sm">
                    </div>

                    <!-- Access Token -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-key mr-1 text-gray-400"></i> Access Token (Optional)
                        </label>
                        <div class="relative">
                            <input :type="showGitToken ? 'text' : 'password'" 
                                v-model="gitConfig.access_token" 
                                placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                                class="w-full px-4 py-2.5 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition font-mono text-sm">
                            <button type="button" @click="showGitToken = !showGitToken" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i :class="showGitToken ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Personal access token for private repositories</p>
                    </div>

                    <!-- Status Info -->
                    <div v-if="gitConfig.configured" class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center gap-2 text-green-700">
                            <i class="fas fa-check-circle"></i>
                            <span class="font-medium">Repository configured</span>
                        </div>
                        <p v-if="gitConfig.last_sync" class="text-sm text-green-600 mt-1">
                            Last sync: [[ new Date(gitConfig.last_sync).toLocaleString() ]]
                        </p>
                    </div>

                    <!-- Save & Test Buttons -->
                    <div class="flex gap-3">
                        <button @click="saveGitConfig" 
                            :disabled="gitSyncLoading"
                            class="flex-1 px-4 py-2.5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50 transition font-medium flex items-center justify-center gap-2">
                            <i :class="gitSyncLoading ? 'fas fa-spinner fa-spin' : 'fas fa-save'"></i>
                            Save Configuration
                        </button>
                        <button @click="testGitConnection" 
                            :disabled="gitSyncLoading || !gitConfig.repo_url"
                            class="px-4 py-2.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 transition font-medium flex items-center gap-2">
                            <i :class="gitTestLoading ? 'fas fa-spinner fa-spin' : 'fas fa-plug'"></i>
                            Test
                        </button>
                    </div>

                    <!-- Message Display -->
                    <div v-if="gitSyncMessage" 
                        :class="gitSyncMessage.startsWith('Error') ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'"
                        class="border rounded-lg p-3 text-sm">
                        [[ gitSyncMessage ]]
                    </div>
                </div>

                <!-- Sync Tab -->
                <div v-if="gitSyncTab === 'sync'" class="space-y-5">
                    <!-- Not Configured Warning -->
                    <div v-if="!gitConfig.configured" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
                        <p class="text-yellow-700 font-medium">Repository not configured</p>
                        <p class="text-yellow-600 text-sm mt-1">Please configure a Git repository first</p>
                        <button @click="gitSyncTab = 'config'" class="mt-3 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition text-sm font-medium">
                            Go to Configuration
                        </button>
                    </div>

                    <!-- Sync Options -->
                    <div v-else class="space-y-4">
                        <!-- Export Section -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-5">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-upload text-blue-600 text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-blue-800">Export to Git</h4>
                                    <p class="text-blue-600 text-sm mt-1">Push all templates to the configured Git repository</p>
                                    <p class="text-blue-500 text-xs mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        [[ templates.length ]] templates will be exported to the "scripts" folder
                                    </p>
                                    <button @click="exportToGit" 
                                        :disabled="gitSyncLoading || templates.length === 0"
                                        class="mt-3 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition font-medium flex items-center gap-2">
                                        <i :class="gitExportLoading ? 'fas fa-spinner fa-spin' : 'fas fa-cloud-upload-alt'"></i>
                                        [[ gitExportLoading ? 'Exporting...' : 'Export Templates' ]]
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Import Section -->
                        <div class="bg-green-50 border border-green-200 rounded-xl p-5">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-download text-green-600 text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-green-800">Import from Git</h4>
                                    <p class="text-green-600 text-sm mt-1">Pull templates from the configured Git repository</p>
                                    
                                    <!-- Import Options -->
                                    <div class="mt-3 flex items-center gap-4">
                                        <label class="flex items-center gap-2 text-sm text-green-700 cursor-pointer">
                                            <input type="checkbox" v-model="gitImportOverwrite" class="rounded border-green-400 text-green-600 focus:ring-green-500">
                                            Overwrite existing templates
                                        </label>
                                    </div>

                                    <div class="flex gap-3 mt-3">
                                        <button @click="previewGitImport" 
                                            :disabled="gitSyncLoading"
                                            class="px-4 py-2.5 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 disabled:opacity-50 transition font-medium flex items-center gap-2">
                                            <i :class="gitPreviewLoading ? 'fas fa-spinner fa-spin' : 'fas fa-eye'"></i>
                                            Preview
                                        </button>
                                        <button @click="importFromGit" 
                                            :disabled="gitSyncLoading"
                                            class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition font-medium flex items-center gap-2">
                                            <i :class="gitImportLoading ? 'fas fa-spinner fa-spin' : 'fas fa-cloud-download-alt'"></i>
                                            [[ gitImportLoading ? 'Importing...' : 'Import Templates' ]]
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Import Preview -->
                        <div v-if="gitImportPreview && gitImportPreview.templates.length > 0" class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">
                                <i class="fas fa-list mr-2"></i>Import Preview ([[ gitImportPreview.total ]] templates)
                            </h4>
                            <div class="max-h-48 overflow-y-auto space-y-2">
                                <div v-for="t in gitImportPreview.templates" :key="t.filename" 
                                    class="flex items-center justify-between py-2 px-3 bg-white rounded-lg border border-gray-100">
                                    <div class="flex items-center gap-3">
                                        <i :class="t.script_type === 'python' ? 'fab fa-python text-yellow-500' : 'fas fa-terminal text-gray-500'"></i>
                                        <span class="text-sm font-medium text-gray-700">[[ t.name ]]</span>
                                    </div>
                                    <span :class="t.exists ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'" 
                                        class="text-xs px-2 py-0.5 rounded-full">
                                        [[ t.exists ? 'Update' : 'New' ]]
                                    </span>
                                </div>
                            </div>
                            <div class="mt-3 text-xs text-gray-500 flex gap-4">
                                <span><i class="fas fa-plus-circle text-green-500 mr-1"></i>[[ gitImportPreview.new ]] new</span>
                                <span><i class="fas fa-sync text-yellow-500 mr-1"></i>[[ gitImportPreview.existing ]] existing</span>
                            </div>
                        </div>

                        <!-- Message Display -->
                        <div v-if="gitSyncMessage" 
                            :class="gitSyncMessage.startsWith('Error') ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'"
                            class="border rounded-lg p-3 text-sm">
                            [[ gitSyncMessage ]]
                        </div>
                    </div>
                </div>

                <!-- Backup Tab -->
                <div v-if="gitSyncTab === 'backup'" class="space-y-5">
                    <!-- Not Configured Warning -->
                    <div v-if="!gitConfig.configured" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
                        <p class="text-yellow-700 font-medium">Repository not configured</p>
                        <p class="text-yellow-600 text-sm mt-1">Please configure a Git repository first</p>
                        <button @click="gitSyncTab = 'config'" class="mt-3 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition text-sm font-medium">
                            Go to Configuration
                        </button>
                    </div>

                    <!-- Backup Options -->
                    <div v-else class="space-y-4">
                        <!-- Info Banner -->
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-xl p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-purple-600 text-xl mt-1"></i>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-purple-800 mb-1">Full System Backup</h4>
                                    <p class="text-purple-700 text-sm">
                                        This creates a complete backup of your BashTower instance including templates, hosts, groups, cron jobs, and configuration.
                                        The backup is stored in a dedicated <strong>backup</strong> branch.
                                    </p>
                                    <p class="text-purple-600 text-xs mt-2">
                                        <i class="fas fa-shield-alt mr-1"></i>
                                        By default, SSH private keys, passwords, and API tokens are excluded. Enable "Include Sensitive Data" to backup everything.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Full Backup Section -->
                        <div class="bg-purple-50 border border-purple-200 rounded-xl p-5">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-database text-purple-600 text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-purple-800">Backup Everything</h4>
                                    <p class="text-purple-600 text-sm mt-1">Create a complete backup of all data to Git repository</p>
                                    <p class="text-purple-500 text-xs mt-2">
                                        <i class="fas fa-code-branch mr-1"></i>
                                        Branch: <strong>backup</strong>
                                    </p>
                                    <p class="text-purple-500 text-xs mt-1" v-if="backupStats">
                                        Will backup: 
                                        <strong>[[ templates.length ]]</strong> templates,
                                        <strong>[[ backupStats.hosts || 0 ]]</strong> hosts,
                                        <strong>[[ backupStats.groups || 0 ]]</strong> groups
                                    </p>
                                    
                                    <!-- Sensitive Data Option -->
                                    <div class="mt-3 flex items-center gap-4">
                                        <label class="flex items-center gap-2 text-sm text-purple-700 cursor-pointer">
                                            <input type="checkbox" v-model="gitBackupIncludeSensitive" class="rounded border-purple-400 text-purple-600 focus:ring-purple-500">
                                            Include sensitive data (SSH keys, passwords, API tokens)
                                        </label>
                                    </div>
                                    
                                    <div v-if="gitBackupIncludeSensitive" class="bg-orange-50 border border-orange-300 rounded-lg p-3 mt-3 text-sm text-orange-800">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <strong>Warning:</strong> Sensitive data will be included. Keep your repository private and secure!
                                    </div>
                                    
                                    <button @click="backupToGit" 
                                        :disabled="gitBackupLoading"
                                        class="mt-3 px-5 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 transition font-medium flex items-center gap-2">
                                        <i :class="gitBackupLoading ? 'fas fa-spinner fa-spin' : 'fas fa-cloud-upload-alt'"></i>
                                        [[ gitBackupLoading ? 'Creating Backup...' : 'Create Full Backup' ]]
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Restore Section -->
                        <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-5">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-undo-alt text-indigo-600 text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-indigo-800">Restore from Backup</h4>
                                    <p class="text-indigo-600 text-sm mt-1">Restore data from the backup branch</p>
                                    
                                    <!-- Restore Options -->
                                    <div class="mt-3 flex items-center gap-4">
                                        <label class="flex items-center gap-2 text-sm text-indigo-700 cursor-pointer">
                                            <input type="checkbox" v-model="gitRestoreOverwrite" class="rounded border-indigo-400 text-indigo-600 focus:ring-indigo-500">
                                            Overwrite existing data
                                        </label>
                                    </div>

                                    <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mt-3 text-sm text-yellow-800">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <strong>Warning:</strong> Restore will modify your current data. Make sure the backup includes all required data.
                                    </div>

                                    <button @click="restoreFromGit" 
                                        :disabled="gitRestoreLoading"
                                        class="mt-3 px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition font-medium flex items-center gap-2">
                                        <i :class="gitRestoreLoading ? 'fas fa-spinner fa-spin' : 'fas fa-download'"></i>
                                        [[ gitRestoreLoading ? 'Restoring...' : 'Restore from Backup' ]]
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Message Display -->
                        <div v-if="gitSyncMessage" 
                            :class="gitSyncMessage.startsWith('Error') ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'"
                            class="border rounded-lg p-3 text-sm">
                            [[ gitSyncMessage ]]
                        </div>

                        <!-- Refresh Button -->
                        <div v-if="showRefreshButton" class="text-center">
                            <button @click="refreshPage" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium flex items-center gap-2 mx-auto">
                                <i class="fas fa-sync-alt"></i>
                                Refresh Page to See All Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button @click="closeGitSyncModal" class="px-5 py-2.5 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-file-code text-blue-600"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-800">[[ templates.length ]]</p>
                <p class="text-xs text-gray-500">Total Templates</p>
            </div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-terminal text-gray-600"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-800">[[ templates.filter(t => (t.script_type || 'bash') === 'bash').length ]]</p>
                <p class="text-xs text-gray-500">Bash Scripts</p>
            </div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                <i class="fab fa-python text-yellow-600"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-800">[[ templates.filter(t => t.script_type === 'python').length ]]</p>
                <p class="text-xs text-gray-500">Python Scripts</p>
            </div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-code text-green-600"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-800">[[ templates.reduce((sum, t) => sum + (t.script ? t.script.replace(/\r\n|\r/g, '\n').replace(/\n+$/,'').split('\n').length : 0), 0) ]]</p>
                <p class="text-xs text-gray-500">Total Lines</p>
            </div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-robot text-purple-600"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-800" :class="aiConfigured ? 'text-green-600' : 'text-gray-400'">[[ aiConfigured ? 'Ready' : 'Off' ]]</p>
                <p class="text-xs text-gray-500">AI Assistant</p>
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div v-if="editingTemplate" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="cancelEdit">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="p-5 flex justify-between items-center"
                :class="templateForm.script_type === 'python' ? 'bg-gradient-to-r from-yellow-500 to-orange-500' : 'bg-gradient-to-r from-blue-600 to-indigo-700'">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                        <i :class="templateForm.script_type === 'python' ? 'fab fa-python' : (templateForm.id ? 'fas fa-edit' : 'fas fa-plus')" class="text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg">[[ templateForm.id ? 'Edit Template' : 'New Template' ]]</h3>
                        <p class="text-white/70 text-sm">Create or modify [[ templateForm.script_type === 'python' ? 'Python' : 'Bash' ]] scripts</p>
                    </div>
                </div>
                <button @click="cancelEdit" class="w-10 h-10 rounded-lg bg-white/10 hover:bg-white/20 transition flex items-center justify-center text-white">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-5 space-y-5">
                <!-- Script Type Selector -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-code mr-1 text-gray-400"></i> Script Type
                    </label>
                    <div class="flex gap-3">
                        <button type="button" 
                            @click="templateForm.script_type = 'bash'"
                            :class="[
                                'flex-1 py-3 px-4 rounded-xl font-medium text-sm transition flex items-center justify-center gap-3 border-2',
                                templateForm.script_type === 'bash' 
                                    ? 'bg-gray-900 text-green-400 border-gray-700 ring-2 ring-green-500' 
                                    : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200'
                            ]">
                            <i class="fas fa-terminal text-lg"></i>
                            <div class="text-left">
                                <p class="font-semibold">Bash Script</p>
                                <p class="text-xs opacity-70">Shell commands & scripts</p>
                            </div>
                        </button>
                        <button type="button"
                            @click="templateForm.script_type = 'python'"
                            :class="[
                                'flex-1 py-3 px-4 rounded-xl font-medium text-sm transition flex items-center justify-center gap-3 border-2',
                                templateForm.script_type === 'python' 
                                    ? 'bg-slate-800 text-yellow-400 border-slate-700 ring-2 ring-yellow-500' 
                                    : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200'
                            ]">
                            <i class="fab fa-python text-lg"></i>
                            <div class="text-left">
                                <p class="font-semibold">Python Script</p>
                                <p class="text-xs opacity-70">Python 3 automation</p>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Name Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tag mr-1 text-gray-400"></i> Template Name
                    </label>
                    <input v-model="templateForm.name" placeholder="e.g., Deployment Script, Backup Job..." 
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                </div>

                <!-- Arguments Configuration -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-sliders-h mr-1 text-gray-400"></i> Script Arguments
                        </label>
                        <button type="button" @click="addArgument" 
                            class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 transition flex items-center gap-1">
                            <i class="fas fa-plus"></i> Add Argument
                        </button>
                    </div>
                    
                    <div v-if="templateForm.arguments && templateForm.arguments.length > 0" class="space-y-3 max-h-48 overflow-y-auto">
                        <div v-for="(arg, index) in templateForm.arguments" :key="index" 
                            class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <div class="flex items-start gap-3">
                                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Variable Name</label>
                                        <input v-model="arg.name" placeholder="server_name" 
                                            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none font-mono">
                                        <p v-if="arg.name" class="text-xs text-gray-500 mt-1">Use: <code class="bg-gray-200 px-1 rounded">[[ getArgumentPlaceholder(arg) ]]</code></p>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Label</label>
                                        <input v-model="arg.label" placeholder="Server Name" 
                                            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Type</label>
                                        <select v-model="arg.type" 
                                            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                            <option value="text">Text</option>
                                            <option value="password">Password</option>
                                            <option value="number">Number</option>
                                            <option value="select">Select</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="button" @click="removeArgument(index)" 
                                    class="w-8 h-8 text-red-500 hover:bg-red-50 rounded transition flex items-center justify-center">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Default Value</label>
                                    <input v-model="arg.default_value" placeholder="Optional default value" 
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center text-xs text-gray-600">
                                        <input type="checkbox" v-model="arg.required" class="mr-2">
                                        Required
                                    </label>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Description</label>
                                <textarea v-model="arg.description" placeholder="Optional description for this argument" 
                                    class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                                    rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="!templateForm.arguments || templateForm.arguments.length === 0" 
                        class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg border border-gray-200">
                        <i class="fas fa-sliders-h text-2xl mb-2 text-gray-400"></i>
                        <p class="text-sm">No arguments defined. Click "Add Argument" to make your script dynamic.</p>
                        <p class="text-xs mt-1">Arguments allow users to provide values when executing the script.</p>
                    </div>
                </div>

                <!-- Script Editor -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i :class="templateForm.script_type === 'python' ? 'fab fa-python' : 'fas fa-terminal'" class="mr-1 text-gray-400"></i> 
                        [[ templateForm.script_type === 'python' ? 'Python' : 'Bash' ]] Script
                    </label>
                    <div class="relative rounded-xl overflow-hidden border border-gray-700">
                        <div class="px-4 py-2 flex items-center justify-between border-b border-gray-700"
                            :class="templateForm.script_type === 'python' ? 'bg-slate-800' : 'bg-gray-800'">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                <span :class="templateForm.script_type === 'python' ? 'text-yellow-400' : 'text-gray-400'" class="text-xs ml-2 font-mono">
                                    [[ templateForm.script_type === 'python' ? 'python3' : 'bash' ]]
                                </span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-xs text-gray-500">
                                    <span>[[ templateForm.script ? templateForm.script.replace(/\r\n|\r/g, '\n').replace(/\n+$/, '').split('\n').length : 0 ]] lines</span>
                                    <span class="mx-2">•</span>
                                    <span>[[ templateForm.script ? templateForm.script.length : 0 ]] chars</span>
                                </div>
                                <button @click="toggleTemplateEditorExpand" class="text-xs px-3 py-1 rounded bg-gray-700/30 hover:bg-gray-700/40 text-white">[[ templateEditorExpanded ? 'Collapse' : 'Expand' ]]</button>
                            </div>
                        </div>
                        <textarea v-model="templateForm.script"
                            spellcheck="false" autocorrect="off" autocapitalize="off" autocomplete="off"
                            :placeholder="templateForm.script_type === 'python' ? '#!/usr/bin/env python3\n\n# Your Python script here...' : '#!/bin/bash\n\n# Your script here...'"
                            :class="[ templateForm.script_type === 'python' ? 'bg-slate-900 text-yellow-300' : 'bg-gray-900 text-green-400', templateEditorExpanded ? 'min-h-[36rem] max-h-[80vh]' : 'h-72 min-h-[16rem] max-h-[40rem]' ]"
                            class="w-full p-4 font-mono text-sm focus:outline-none resize-y"
                            style="font-family: 'Courier New', Consolas, 'Liberation Mono', monospace;"></textarea>
                    </div>
                </div>

                <!-- AI Script Assistant -->
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-200 overflow-hidden">
                    <div class="p-4 bg-gradient-to-r from-purple-100/50 to-indigo-100/50 border-b border-purple-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-robot text-white text-sm"></i>
                            </div>
                            <div>
                                <span class="font-semibold text-purple-800">AI Script Assistant</span>
                                <span v-if="!aiConfigured" class="ml-2 text-xs text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full">Configure in Settings</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex gap-2">
                            <input v-model="scriptAIPrompt" 
                                   @keyup.enter="askScriptAI"
                                   :disabled="scriptAILoading"
                                   :placeholder="'Describe what you want the ' + (templateForm.script_type === 'python' ? 'Python' : 'bash') + ' script to do...'"
                                   class="flex-1 px-4 py-2.5 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none transition">
                            <button @click="askScriptAI" 
                                    :disabled="scriptAILoading || !aiConfigured"
                                    class="px-5 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium flex items-center gap-2">
                                <i :class="scriptAILoading ? 'fas fa-spinner fa-spin' : 'fas fa-magic'"></i>
                                [[ scriptAILoading ? 'Generating...' : 'Generate' ]]
                            </button>
                        </div>

                        <!-- AI Response -->
                        <div v-if="scriptAIResponse" class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-purple-700 flex items-center gap-1">
                                    <i class="fas fa-sparkles"></i> AI Suggestion
                                </span>
                                <div class="flex gap-2">
                                    <button @click="applyAIScript" 
                                            v-if="!scriptAIResponse.startsWith('Error:') && !scriptAIResponse.startsWith('Network error:')"
                                            class="px-3 py-1.5 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition font-medium flex items-center gap-1">
                                        <i class="fas fa-check"></i> Apply
                                    </button>
                                    <button @click="clearAIResponse" class="px-3 py-1.5 bg-gray-500 text-white text-xs rounded-lg hover:bg-gray-600 transition font-medium flex items-center gap-1">
                                        <i class="fas fa-times"></i> Dismiss
                                    </button>
                                    <button @click="toggleScriptAIExpand" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-xs rounded-lg hover:bg-gray-300 transition">[[ scriptAIExpanded ? 'Collapse' : 'Expand' ]]</button>
                                </div>
                            </div>
                            <pre :class="[ templateForm.script_type === 'python' ? 'bg-slate-900 text-yellow-300' : 'bg-gray-900 text-green-400', scriptAIExpanded ? 'max-h-[36rem]' : 'max-h-48', 'script-ai-response' ]" 
                                class="p-4 rounded-lg text-sm overflow-x-auto overflow-y-auto font-mono" style="resize:vertical;">[[ scriptAIResponse ]]</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                <button @click="cancelEdit" class="px-5 py-2.5 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">
                    Cancel
                </button>
                <button @click="saveTemplate" class="px-6 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition font-medium flex items-center gap-2 shadow-md">
                    <i class="fas fa-save"></i> Save Template
                </button>
            </div>
        </div>
    </div>

    <!-- Templates Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
        <div v-for="t in filteredTemplates" :key="t.id" 
            class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden group">

            <!-- Preview Modal -->
            <div v-if="previewOpen && previewTemplate && previewTemplate.id === t.id" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 p-4" @click.self="closePreview">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
                    <div class="p-4 flex items-center justify-between bg-gray-800 text-white">
                        <div class="flex items-center gap-3">
                            <i class="fab fa-python text-yellow-300" v-if="previewTemplate.script_type === 'python'"></i>
                            <i class="fas fa-terminal text-white" v-else></i>
                            <div class="ml-2">
                                <div class="font-semibold">[[ previewTemplate.name ]]</div>
                                <div class="text-xs text-gray-300">[[ previewTemplate.script_type ]] • [[ previewTemplate.script ? previewTemplate.script.replace(/\r\n|\r/g,'\n').replace(/\n+$/,'').split('\n').length : 0 ]] lines</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click.stop="copyScriptFromPreview" class="px-3 py-1.5 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition">Copy</button>
                            <button @click.stop="closePreview" class="px-3 py-1.5 bg-white/10 text-white rounded text-xs hover:bg-white/20 transition">Close</button>
                        </div>
                    </div>
                    <div class="p-4 overflow-auto bg-black text-gray-100">
                        <pre id="template-preview" class="rounded text-sm bg-black"><code :class="'language-' + (previewTemplate.script_type === 'python' ? 'python' : 'bash')" v-text="previewTemplate.script"></code></pre>
                    </div>
                </div>
            </div>
            <!-- Header -->
            <div class="p-4 flex items-center gap-3"
                :class="t.script_type === 'python' ? 'bg-gradient-to-r from-yellow-500 to-orange-500' : 'bg-gradient-to-r from-blue-500 to-indigo-600'">
                <div class="w-11 h-11 bg-white/20 rounded-xl flex items-center justify-center">
                    <i :class="t.script_type === 'python' ? 'fab fa-python' : 'fas fa-terminal'" class="text-white text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-white truncate" :title="t.name">[[ t.name ]]</h4>
                    <span class="text-xs text-white/70 font-mono">[[ t.script_type === 'python' ? 'Python' : 'Bash' ]] • ID: [[ t.id ]]</span>
                </div>
                <!-- Preview button aligned to the right of the header (after the ID) -->
                <div class="ml-4 flex-shrink-0">
                    <button @click.stop="openPreview(t)" class="text-xs px-3 py-1.5 bg-white/10 text-white rounded hover:bg-white/20 transition">Preview</button>
                </div>
            </div>
            
            <!-- Script Preview -->
            <div class="h-28 overflow-hidden relative group-hover:h-36 transition-all duration-300"
                :class="t.script_type === 'python' ? 'bg-slate-900' : 'bg-gray-950'">
                <div class="p-4">
                    <pre :class="t.script_type === 'python' ? 'text-yellow-300' : 'text-green-400'" 
                        class="text-xs font-mono leading-relaxed">[[ t.script ? t.script.substring(0, 200) + (t.script.length > 200 ? '...' : '') : '# Empty script' ]]</pre>
                </div>
                <div class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t to-transparent"
                    :class="t.script_type === 'python' ? 'from-slate-900' : 'from-gray-950'"></div>
            </div>
            
            <!-- Stats Bar -->
            <div class="px-4 py-3 bg-gray-50 border-t border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-4 text-xs text-gray-500">
                    <span class="flex items-center gap-1">
                            <i class="fas fa-code" :class="t.script_type === 'python' ? 'text-yellow-500' : 'text-blue-500'"></i>
                            [[ t.script ? t.script.replace(/\r\n|\r/g, '\n').replace(/\n+$/,'').split('\n').length : 0 ]] lines
                    </span>
                    <span class="flex items-center gap-1">
                        <i class="fas fa-text-width text-purple-500"></i>
                        [[ t.script ? t.script.length : 0 ]] chars
                    </span>
                </div>
                <span v-if="t.script && (t.script_type === 'python' || t.script.includes('#!/usr/bin/env python') || t.script.includes('#!/usr/bin/python'))"
                    class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">
                    <i class="fab fa-python"></i> Python
                </span>
                <span v-else class="text-xs px-2 py-0.5 rounded-full"
                    :class="t.script_type === 'python' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'">
                    <i :class="t.script_type === 'python' ? 'fab fa-python' : 'fas fa-terminal'" class="mr-1"></i>
                    [[ t.script_type === 'python' ? 'Python' : 'Bash' ]]
                </span>
            </div>
            
            <!-- Actions Footer -->
            <div class="px-4 py-3 flex justify-between items-center">
                <button @click="editTemplate(t)" class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium flex items-center gap-1">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <div class="flex items-center gap-2">
                    <button @click="deleteTemplate(t.id)" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition text-sm font-medium flex items-center gap-1">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty States -->
        <div v-if="templates.length === 0" class="col-span-full">
            <div class="bg-white rounded-xl border-2 border-dashed border-gray-300 p-16 text-center">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-code text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Templates Yet</h3>
                <p class="text-gray-500 mb-6">Create your first script template (Bash or Python) to get started</p>
                <button @click="startNewTemplate" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium inline-flex items-center gap-2">
                    <i class="fas fa-plus"></i> Create Your First Template
                </button>
            </div>
        </div>
        <div v-else-if="filteredTemplates.length === 0" class="col-span-full">
            <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-search text-gray-400 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Results Found</h3>
                <p class="text-gray-500">No templates match "<span class="font-medium">[[ templateSearchQuery ]]</span>"</p>
            </div>
        </div>
    </div>
</div>