<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bash Tower</title>
    <link rel="icon" href="{{ url_for('static', filename='img/BashTower.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for syntax highlighting of scripts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/monokai-sublime.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <style>
        /* Prevents the template from showing before Vue is ready */
        [v-cloak] { display: none; }
        /* Full-page loading overlay shown on initial load/refresh */
        #page-loading-overlay{
            position:fixed;
            inset:0;
            display:flex;
            align-items:center;
            justify-content:center;
            background:#f3f4f6; /* solid white background */
            color:#111827; /* dark text */
            z-index:9999;
            transition:opacity .25s ease,visibility .25s ease;
        }

        /* subtle tower watermark behind the loader */
        #page-loading-overlay::before{
            content: "";
            position:absolute;
            inset:0;
            background-image: url("{{ url_for('static', filename='img/BashTower.png') }}");
            background-repeat: no-repeat;
            background-position: center 50%;
            background-size: 30%; /* larger watermark */
            opacity: 0.99; /* brighter */
            pointer-events: none;
            z-index: 0;
            background-blend-mode: normal;
        }
        #page-loading-overlay.hidden{
            opacity:0;
            visibility:hidden;
            pointer-events:none;
        }
        .loader-ring{
            width:196px; /* larger spinner */
            height:196px;
            border:10px solid rgba(17,24,39,0.06); /* subtle ring */
            border-top-color:#6d7774; /* orange spinner */
            border-radius:50%;
            animation:spin 1s linear infinite;
            margin-right:1px;
        }
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">
    <!-- Loading overlay (visible immediately on refresh) -->
    <div id="page-loading-overlay">
        <div class="flex items-center relative z-10">
            <div class="loader-ring" aria-hidden="true"></div>
      
        </div>
    </div>

    <div id="app" class="flex h-full" v-cloak>
        <!-- Sidebar Navigation -->
        <div class="w-64 bg-slate-800 text-white flex flex-col">
            <div class="p-4 text-2xl font-bold border-b border-slate-700">
                <a href="#" onclick="location.reload();" class="flex items-center text-white no-underline">
                    <i class="fas fa-tower-broadcast mr-2"></i>
                    <span>Bash Tower</span>
                </a>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <!-- Navigation Buttons -->
                <button @click="currentView = 'dashboard'" :class="currentView === 'dashboard' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-tachometer-alt w-6"></i> <span>Dashboard</span>
                </button>
                <button @click="currentView = 'templates'" :class="currentView === 'templates' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-file-code w-6"></i> <span>Templates</span>
                </button>
                <button @click="currentView = 'cronjobs'" :class="currentView === 'cronjobs' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-clock w-6"></i> <span>Cron Jobs</span>
                </button>
                <button @click="currentView = 'cronHistory'" :class="currentView === 'cronHistory' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-history w-6"></i> <span>Cron History</span>
                </button>
                <button @click="currentView = 'hosts'" :class="currentView === 'hosts' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-server w-6"></i> <span>Hosts</span>
                </button>
                <button @click="currentView = 'groups'" :class="currentView === 'groups' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-layer-group w-6"></i> <span>Host Groups</span>
                </button>
                <button @click="currentView = 'keys'" :class="currentView === 'keys' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-key w-6"></i> <span>SSH Keys</span>
                </button>
                <button @click="currentView = 'satellite'" :class="currentView === 'satellite' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-satellite-dish w-6"></i> <span>Satellite Sync</span>
                </button>
                <button @click="currentView = 'settings'" :class="currentView === 'settings' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-cog w-6"></i> <span>Settings</span>
                </button>
                <button v-if="currentUser && currentUser.is_admin" @click="currentView = 'users'" :class="currentView === 'users' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-users-cog w-6"></i> <span>Users</span>
                </button>
                <button @click="currentView = 'about'" :class="currentView === 'about' ? 'bg-blue-600' : 'hover:bg-slate-700'" class="w-full text-left p-2 rounded transition flex items-center">
                    <i class="fas fa-info-circle w-6"></i> <span>About</span>
                </button>
            </nav>
        </div>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow p-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold capitalize">[[ currentView === 'cronHistory' ? 'Cron History' : currentView ]]</h2>
                <div class="flex items-center gap-4">
                    <div v-if="currentUser" class="flex items-center gap-2 text-gray-600">
                        <i class="fas fa-user-circle text-lg"></i>
                        <span class="text-sm font-medium">[[ currentUser.username ]]</span>
                        <span v-if="currentUser.is_admin" class="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">
                            <i class="fas fa-crown mr-1"></i>Admin
                        </span>
                    </div>
                    <button v-if="!authDisabled" @click="logout" class="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg transition flex items-center gap-1">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-auto p-6">
                <!-- Using v-if ensures that content is only rendered when active -->
                <div v-if="currentView === 'dashboard'">
                    {% include 'dashboard.html' %}
                </div>
                <div v-if="currentView === 'templates'">
                    {% include 'templates.html' %}
                </div>
                <div v-if="currentView === 'cronjobs'">
                    {% include 'cronjobs.html' %}
                </div>
                <div v-if="currentView === 'cronHistory'">
                    {% include 'cronhistory.html' %}
                </div>
                <div v-if="currentView === 'hosts'">
                    {% include 'hosts.html' %}
                </div>
                <div v-if="currentView === 'groups'">
                    {% include 'groups.html' %}
                </div>
                <div v-if="currentView === 'keys'">
                    {% include 'keys.html' %}
                </div>
                <div v-if="currentView === 'satellite'">
                    {% include 'satellite.html' %}
                </div>
                <div v-if="currentView === 'settings'">
                    {% include 'settings.html' %}
                </div>
                <div v-if="currentView === 'users'">
                    {% include 'users.html' %}
                </div>
                <div v-if="currentView === 'about'">
                    {% include 'about.html' %}
                </div>
            </main>
        </div>
    </div>

    <!-- Load Module Scripts (must be loaded before main.js) -->
    <script src="{{ url_for('static', filename='js/modules/templates.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/hosts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/groups.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/keys.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/jobs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/satellite.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/cronjobs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/cronhistory.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/users.js') }}"></script>
    
    <!-- Initialize highlight.js (will highlight dynamic content when needed) -->
    <script>
        // Avoid running until hljs is available
        function highlightCodeBlock(el) {
            if (window.hljs && el) {
                try {
                    window.hljs.highlightElement(el);
                } catch (e) {
                    console.warn('Highlight failed', e);
                }
            }
        }
    </script>

    <!-- Main Application Entry Point -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        (function(){
            const overlay = document.getElementById('page-loading-overlay');
            if(!overlay) return;
            const minMs = 300; // keep overlay visible at least this long (300ms < 1s)
            const start = Date.now();

            function hideOverlay(){
                const elapsed = Date.now() - start;
                const wait = Math.max(0, minMs - elapsed);
                setTimeout(()=>{
                    overlay.classList.add('hidden');
                    // remove from DOM after transition
                    setTimeout(()=>{ if(overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); }, 300);
                }, wait);
            }

            if(document.readyState === 'complete'){
                hideOverlay();
            } else {
                window.addEventListener('load', hideOverlay);
                // in case load doesn't fire, ensure we hide after a reasonable timeout
                setTimeout(hideOverlay, 5000);
            }
        })();
    </script>
</body>
</html>